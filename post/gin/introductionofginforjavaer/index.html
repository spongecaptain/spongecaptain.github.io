<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>写给 Java 程序员的 Go Web 框架 Gin 源码入门 - Spongecaptain 的个人技术博客</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Spongecaptain" /><meta name="description" content="本文会比较 Gin 与 Netty 以及 Spring 在一些设计上的异同。如果你没有 Java 开发经验，也完全可以略去对比 Java 的部分内容，并不影响理解本文。 1. Gin 启动过程过程概述 下面是" /><meta name="keywords" content="Gin" />






<meta name="generator" content="Hugo 0.82.0 with theme even" />


<link rel="canonical" href="https://spongecaptain.cool/post/gin/introductionofginforjavaer/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.20eaaf634d4dd8fdd9ee27392a8a8d7542264cd21577a22499a924b5f4a112ef.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="写给 Java 程序员的 Go Web 框架 Gin 源码入门" />
<meta property="og:description" content="本文会比较 Gin 与 Netty 以及 Spring 在一些设计上的异同。如果你没有 Java 开发经验，也完全可以略去对比 Java 的部分内容，并不影响理解本文。 1. Gin 启动过程过程概述 下面是" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://spongecaptain.cool/post/gin/introductionofginforjavaer/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-19T16:50:11&#43;08:00" />
<meta property="article:modified_time" content="2021-05-19T16:50:11&#43;08:00" />

<meta itemprop="name" content="写给 Java 程序员的 Go Web 框架 Gin 源码入门">
<meta itemprop="description" content="本文会比较 Gin 与 Netty 以及 Spring 在一些设计上的异同。如果你没有 Java 开发经验，也完全可以略去对比 Java 的部分内容，并不影响理解本文。 1. Gin 启动过程过程概述 下面是"><meta itemprop="datePublished" content="2021-05-19T16:50:11&#43;08:00" />
<meta itemprop="dateModified" content="2021-05-19T16:50:11&#43;08:00" />
<meta itemprop="wordCount" content="4939">
<meta itemprop="keywords" content="Gin," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="写给 Java 程序员的 Go Web 框架 Gin 源码入门"/>
<meta name="twitter:description" content="本文会比较 Gin 与 Netty 以及 Spring 在一些设计上的异同。如果你没有 Java 开发经验，也完全可以略去对比 Java 的部分内容，并不影响理解本文。 1. Gin 启动过程过程概述 下面是"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body class = body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Spongecaptain&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/about/index.html">
        <li class="mobile-menu-item">关于</li>
      </a><a href="https://spongecaptain.cool/SimpleClearFileIO/">
        <li class="mobile-menu-item">文件I/O简明概述</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Spongecaptain&#39;s Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/index.html">关于</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://spongecaptain.cool/SimpleClearFileIO/">文件I/O简明概述</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">写给 Java 程序员的 Go Web 框架 Gin 源码入门</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-05-19 </span>
        <div class="post-category">
            <a href="/categories/gin/"> Gin </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-gin-启动过程过程概述">1. Gin 启动过程过程概述</a></li>
    <li><a href="#2-gin-中的请求处理-拦截过滤器模式">2. Gin 中的请求处理-拦截过滤器模式</a></li>
    <li><a href="#3-默认的中间件-logger-以及-recovery">3. 默认的中间件 Logger 以及 Recovery</a></li>
    <li><a href="#4-gin-的-goroutine-模型">4. Gin 的 Goroutine 模型</a></li>
    <li><a href="#5-summary">5. SUMMARY</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p>本文会比较 Gin 与 Netty 以及 Spring 在一些设计上的异同。如果你没有 Java 开发经验，也完全可以略去对比 Java 的部分内容，并不影响理解本文。</p>
</blockquote>
<h2 id="1-gin-启动过程过程概述">1. Gin 启动过程过程概述</h2>
<p>下面是使用 Gin 实现监听本机端口 2333，然后返回一个 hello world 字符串作为 HTTP 响应正文，最终返回给前端的最简单案例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;net/http&#34;</span>

	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>

	<span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;Hello World!&#34;</span><span class="p">)</span>
	<span class="p">})</span>

	<span class="nx">r</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;:2333&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如上的代码块所示，最简单的 Gin 启动逻辑分为三步：</p>
<ol>
<li>得到一个 Engine 结构体实例，其代表 Gin 的执行引擎</li>
<li>配置 Engine 的路由规则，例如当用户访问 <code>/</code> 路径时，逻辑是简单地返回一个 &ldquo;Hello World!&rdquo; 作为 HTTP 响应</li>
<li>负责监听本地 TCP 2333 端口</li>
</ol>
<p>如果你写过 Netty 后台程序，你会发现这与 Netty 后台应用的启动逻辑非常相似。案例来自于：<a href="https://github.com/netty/netty/blob/4.1/example/src/main/java/io/netty/example/http/helloworld/HttpHelloWorldServer.java">Netty-Example-http-helloworld</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">io.netty.example.http.helloworld</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.Channel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.ssl.SslContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.ssl.SslContextBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.ssl.util.SelfSignedCertificate</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * An HTTP server that sends back the content of the received HTTP request
</span><span class="cm"> * in a pretty plaintext form.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">HttpHelloWorldServer</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">SSL</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;ssl&#34;</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;port&#34;</span><span class="o">,</span> <span class="n">SSL</span><span class="o">?</span> <span class="s">&#34;8443&#34;</span> <span class="o">:</span> <span class="s">&#34;8080&#34;</span><span class="o">));</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Configure SSL.
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">SslContext</span> <span class="n">sslCtx</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">SSL</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">SelfSignedCertificate</span> <span class="n">ssc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SelfSignedCertificate</span><span class="o">();</span>
            <span class="n">sslCtx</span> <span class="o">=</span> <span class="n">SslContextBuilder</span><span class="o">.</span><span class="na">forServer</span><span class="o">(</span><span class="n">ssc</span><span class="o">.</span><span class="na">certificate</span><span class="o">(),</span> <span class="n">ssc</span><span class="o">.</span><span class="na">privateKey</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">sslCtx</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// Configure the server.
</span><span class="c1"></span>        <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
            <span class="n">b</span><span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="n">1024</span><span class="o">);</span>
            <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
             <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
             <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingHandler</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span>
             <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpHelloWorldServerInitializer</span><span class="o">(</span><span class="n">sslCtx</span><span class="o">));</span>

            <span class="n">Channel</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">PORT</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>

            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Open your web browser and navigate to &#34;</span> <span class="o">+</span>
                    <span class="o">(</span><span class="n">SSL</span><span class="o">?</span> <span class="s">&#34;https&#34;</span> <span class="o">:</span> <span class="s">&#34;http&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;://127.0.0.1:&#34;</span> <span class="o">+</span> <span class="n">PORT</span> <span class="o">+</span> <span class="sc">&#39;/&#39;</span><span class="o">);</span>

            <span class="n">ch</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>基于 Netty 的 HTTP 后台启动过程如下（过滤掉 SSL 的相关逻辑）：</p>
<ul>
<li>配置基于 Reactor 模型的线程池 bossGroup 以及 workerGroup</li>
<li>配置管道处理 Handler，包含了路由规则配置</li>
<li>监听本地 TCP 8080 端口</li>
</ul>
<p>得益于 Go runtime 对 NIO 网络通信逻辑的封装，Gin 框架并不需要自己实现基于 Reactor 模型的网络通信底层框架。</p>
<h2 id="2-gin-中的请求处理-拦截过滤器模式">2. Gin 中的请求处理-拦截过滤器模式</h2>
<p><a href="https://en.wikipedia.org/wiki/Intercepting_filter_pattern">Intercepting filter pattern</a> 拦截过滤器模式在 Web 后端非常常见，一个请求的处理流程可能包含如下若干步骤：</p>
<ol>
<li>日志</li>
<li>Session/Cookie 逻辑</li>
<li>权限校验</li>
<li>CRUD</li>
<li>异常处理</li>
<li>结果返回</li>
</ol>
<p>同一路由下的大部分请求将经过完全相同的后端处理逻辑，因此使用过<a href="https://www.runoob.com/design-pattern/intercepting-filter-pattern.html">拦截过滤器模式</a>非常合适。</p>
<p><strong>或许，可能你还听说过<a href="https://en.wikipedia.org/wiki/Chain-of-responsibility_pattern">责任链模式</a>？</strong></p>
<p>责任链模式与拦截过滤器模式很接近，区别主要在于：一个请求（也被称为消息）在责任链（或者说管道 Pipeline）上从头向后传播，责任链上的每一个处理器只能处理特定的请求。如果某一个处理器不能处理该请求，通常是将该请求向后传播给其他处理器。如果能够处理，那么处理完成后，可以选择将处理后的结果继续向后传播，或者选择不再传播。总结对比来说：</p>
<ul>
<li><strong>责任链模式</strong>：每一个处理器负责处理前序处理传过来的特定类型消息，每一个处理器能够处理的消息类型通常是不同的。</li>
<li><strong>拦截过滤器模式</strong>：每一个处理器作为整个处理链的一环，每一个处理器能处理的消息通常是同一个类型，就像流水线作业一般，通常在流水线末端才能够产出一个可用的商品。</li>
</ul>
<p>拦截过滤器模式的案例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FilterChain</span> <span class="o">{</span>
   <span class="c1">//过滤器链
</span><span class="c1"></span>   <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Filter</span><span class="o">&gt;</span> <span class="n">filters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Filter</span><span class="o">&gt;();</span>
 	 <span class="c1">//接收结果的 Target 实例
</span><span class="c1"></span>   <span class="kd">private</span> <span class="n">Target</span> <span class="n">target</span><span class="o">;</span>
 	 <span class="c1">//添加一个处理器
</span><span class="c1"></span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addFilter</span><span class="o">(</span><span class="n">Filter</span> <span class="n">filter</span><span class="o">){</span>
      <span class="n">filters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
   <span class="o">}</span>
 	 <span class="c1">//请求在过滤器链上遍历处理（还有一种方式是链式调用）
</span><span class="c1"></span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">request</span><span class="o">){</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">Filter</span> <span class="n">filter</span> <span class="o">:</span> <span class="n">filters</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">filter</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">target</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
   <span class="o">}</span>
 	<span class="c1">//设置结果值
</span><span class="c1"></span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTarget</span><span class="o">(</span><span class="n">Target</span> <span class="n">target</span><span class="o">){</span>
      <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 Gin 框架中利用拦截过滤器模式来处理路由来的请求。</p>
<p>gin.go 源码文件中 Engine.handleHTTPRequest 方法用于处理请求，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">handleHTTPRequest</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">httpMethod</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span>
	<span class="nx">rPath</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span>
	<span class="nx">unescape</span> <span class="o">:=</span> <span class="kc">false</span>
	<span class="k">if</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">UseRawPath</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawPath</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">rPath</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawPath</span>
		<span class="nx">unescape</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">UnescapePathValues</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RemoveExtraSlash</span> <span class="p">{</span>
		<span class="nx">rPath</span> <span class="p">=</span> <span class="nf">cleanPath</span><span class="p">(</span><span class="nx">rPath</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Find root of the tree for the given HTTP method
</span><span class="c1"></span>	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">trees</span>
	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">tl</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">tl</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">t</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">method</span> <span class="o">!=</span> <span class="nx">httpMethod</span> <span class="p">{</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="nx">root</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">root</span>
		<span class="c1">// Find route in tree
</span><span class="c1"></span>		<span class="nx">value</span> <span class="o">:=</span> <span class="nx">root</span><span class="p">.</span><span class="nf">getValue</span><span class="p">(</span><span class="nx">rPath</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">unescape</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nx">Params</span> <span class="p">=</span> <span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span>
			<span class="nx">c</span><span class="p">.</span><span class="nx">fullPath</span> <span class="p">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">fullPath</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
			<span class="nx">c</span><span class="p">.</span><span class="nx">writermem</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">httpMethod</span> <span class="o">!=</span> <span class="s">&#34;CONNECT&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">rPath</span> <span class="o">!=</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">tsr</span> <span class="o">&amp;&amp;</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RedirectTrailingSlash</span> <span class="p">{</span>
				<span class="nf">redirectTrailingSlash</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RedirectFixedPath</span> <span class="o">&amp;&amp;</span> <span class="nf">redirectFixedPath</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RedirectFixedPath</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">HandleMethodNotAllowed</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tree</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">trees</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">tree</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="nx">httpMethod</span> <span class="p">{</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">value</span> <span class="o">:=</span> <span class="nx">tree</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nf">getValue</span><span class="p">(</span><span class="nx">rPath</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">unescape</span><span class="p">);</span> <span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">allNoMethod</span>
				<span class="nf">serveError</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusMethodNotAllowed</span><span class="p">,</span> <span class="nx">default405Body</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">allNoRoute</span>
	<span class="nf">serveError</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">,</span> <span class="nx">default404Body</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中最关键的方法定义于 context.go 源码 Context.Next 方法，用于实现拦截器的遍历：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span>
  <span class="k">for</span> <span class="nx">c</span><span class="p">.</span><span class="nx">index</span> <span class="p">&lt;</span> <span class="nb">int8</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">index</span><span class="p">](</span><span class="nx">c</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可见，Context.Next 方法符合典型的拦截过滤器模式。这种设计与 Spring Interceptor 拦截器设计类似，在 HandlerExecutionChain 的 <a href="https://github.com/spring-projects/spring-framework/blob/main/spring-webmvc/src/main/java/org/springframework/web/servlet/HandlerExecutionChain.java#L145">applyPreHandle</a>、<a href="https://github.com/spring-projects/spring-framework/blob/main/spring-webmvc/src/main/java/org/springframework/web/servlet/HandlerExecutionChain.java#L160">applyPostHandle</a> 以及 <a href="https://github.com/spring-projects/spring-framework/blob/main/spring-webmvc/src/main/java/org/springframework/web/servlet/HandlerExecutionChain.java#L174">triggerAfterCompletion</a> 方法上都能看到拦截过滤器模式的应用。</p>
<p>其中 handlers 切片的元素类型为 HandlersChain 函数，定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">HandlerFunc</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Context</span><span class="p">)</span>
<span class="kd">type</span> <span class="nx">HandlersChain</span> <span class="p">[]</span><span class="nx">HandlerFunc</span>
</code></pre></td></tr></table>
</div>
</div><p>可见，Gin 中每一个 HandlersChain 元素相互并不感知彼此的存在，那么如果前序 HandlersChain 认为该请求不应当继续被后续 HandlersChain 处理，该如何实现？</p>
<p>Context.next() 方法中的 index 不是方法内的局部变量，而是 Context 实例内部字段。可见，我们只要控制此字段的值就能够控制 Next() 方法的执行逻辑。</p>
<p>Context.Abort() 方法能够确保将 index 值置为比 handlers 切片长度更大，这就确保了 Context.Next() 将无法满足 <code>c.index &lt; int8(len(c.handlers))</code> 条件，因而无法继续遍历。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="nx">abortIndex</span> <span class="kt">int8</span> <span class="p">=</span> <span class="nx">math</span><span class="p">.</span><span class="nx">MaxInt8</span> <span class="o">/</span> <span class="mi">2</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">Abort</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">index</span> <span class="p">=</span> <span class="nx">abortIndex</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这种设计与责任链略有不同，责任链中的每一个处理器需要自己显式决定是否将继续将请求交给后续处理器，例如 Netty 的  <a href="https://github.com/netty/netty/blob/4.1/transport/src/main/java/io/netty/channel/ChannelHandlerContext.java#L139">ChannelHandlerContext.fireChannelRead</a>，如果显式调用，就是希望将消息向后传播；否则就是拒绝向后传播，相当于执行了 Context.Aboirt() 方法。</p>
<h2 id="3-默认的中间件-logger-以及-recovery">3. 默认的中间件 Logger 以及 Recovery</h2>
<p><strong>（1）Logger 中间件</strong></p>
<p>Logger 中间件是默认 Engine 自带的中间件，其本质是一个 HandlerFunc 类型的函数，其被 logger.go 中的 LoggerWithConfig 方法返回，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">LoggerWithConfig</span><span class="p">(</span><span class="nx">conf</span> <span class="nx">LoggerConfig</span><span class="p">)</span> <span class="nx">HandlerFunc</span> <span class="p">{</span>
	<span class="nx">formatter</span> <span class="o">:=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">Formatter</span>
	<span class="k">if</span> <span class="nx">formatter</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">formatter</span> <span class="p">=</span> <span class="nx">defaultLogFormatter</span>
	<span class="p">}</span>

	<span class="nx">out</span> <span class="o">:=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">Output</span>
	<span class="k">if</span> <span class="nx">out</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">out</span> <span class="p">=</span> <span class="nx">DefaultWriter</span>
	<span class="p">}</span>

	<span class="nx">notlogged</span> <span class="o">:=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">SkipPaths</span>

	<span class="nx">isTerm</span> <span class="o">:=</span> <span class="kc">true</span>

	<span class="k">if</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">out</span><span class="p">.(</span><span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">||</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;TERM&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;dumb&#34;</span> <span class="o">||</span>
		<span class="p">(!</span><span class="nx">isatty</span><span class="p">.</span><span class="nf">IsTerminal</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nf">Fd</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">isatty</span><span class="p">.</span><span class="nf">IsCygwinTerminal</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nf">Fd</span><span class="p">()))</span> <span class="p">{</span>
		<span class="nx">isTerm</span> <span class="p">=</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">skip</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}</span>

	<span class="k">if</span> <span class="nx">length</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">notlogged</span><span class="p">);</span> <span class="nx">length</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">skip</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{},</span> <span class="nx">length</span><span class="p">)</span>

		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">path</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">notlogged</span> <span class="p">{</span>
			<span class="nx">skip</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{}{}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="c1">//这里返回一个 HandlerFunc 类型的函数
</span><span class="c1"></span>	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Start timer
</span><span class="c1"></span>		<span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
		<span class="nx">path</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span>
		<span class="nx">raw</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span>

		<span class="c1">// Process request，日志依赖于此方法实现方法的计时逻辑
</span><span class="c1"></span>		<span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>

		<span class="c1">// Log only when path is not being skipped
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">skip</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="nx">param</span> <span class="o">:=</span> <span class="nx">LogFormatterParams</span><span class="p">{</span>
				<span class="nx">Request</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
				<span class="nx">isTerm</span><span class="p">:</span>  <span class="nx">isTerm</span><span class="p">,</span>
				<span class="nx">Keys</span><span class="p">:</span>    <span class="nx">c</span><span class="p">.</span><span class="nx">Keys</span><span class="p">,</span>
			<span class="p">}</span>

			<span class="c1">// Stop timer
</span><span class="c1"></span>			<span class="nx">param</span><span class="p">.</span><span class="nx">TimeStamp</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
			<span class="nx">param</span><span class="p">.</span><span class="nx">Latency</span> <span class="p">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">TimeStamp</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>

			<span class="nx">param</span><span class="p">.</span><span class="nx">ClientIP</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ClientIP</span><span class="p">()</span>
			<span class="nx">param</span><span class="p">.</span><span class="nx">Method</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span>
			<span class="nx">param</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">.</span><span class="nf">Status</span><span class="p">()</span>
			<span class="nx">param</span><span class="p">.</span><span class="nx">ErrorMessage</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Errors</span><span class="p">.</span><span class="nf">ByType</span><span class="p">(</span><span class="nx">ErrorTypePrivate</span><span class="p">).</span><span class="nf">String</span><span class="p">()</span>

			<span class="nx">param</span><span class="p">.</span><span class="nx">BodySize</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span>

			<span class="k">if</span> <span class="nx">raw</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
				<span class="nx">path</span> <span class="p">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s">&#34;?&#34;</span> <span class="o">+</span> <span class="nx">raw</span>
			<span class="p">}</span>

			<span class="nx">param</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">path</span>

			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprint</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nf">formatter</span><span class="p">(</span><span class="nx">param</span><span class="p">))</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可见，Logger 对应的 HandlerFunc 函数执行逻辑分为 3 步：</p>
<ol>
<li>在请求被处理前记录一些参数，例如当前时间</li>
<li>利用 Context.Next() 方法进行拦截过滤器的逻辑调用</li>
<li>请求处理后记录一些参数，例如请求处理耗时，并打印相关日志</li>
</ol>
<p><strong>（2）Recovery 中间件</strong></p>
<p>Gin 在其官网上说明其具有 Crash-free 的特点：</p>
<p><img src="../../../images/img_gin/image-20210519130805793.png" alt="image-20210519130805793"></p>
<p><strong>这是如何实现的？</strong></p>
<p>在 Go 中一个简单的 panic 处理如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">badCall</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;bad end&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Panicing %s\r\n&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="nf">badCall</span><span class="p">()</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;After bad call\r\n&#34;</span><span class="p">)</span> <span class="c1">// &lt;-- wordt niet bereikt
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Gin 作为一个 HTTP 框架，应当能够处理任何 panic，并进行 recover，因为 panic 进程停止运行是无法接受的。</p>
<p>Gin 提供一个 HandlerFunc 类型的方法用于捕获所有 panic，其注入 Engine 的逻辑可以从 Gin.Default() 函数出发。该 HandlerFunc 函数在 revobery.go 源码中的 CustomRecoveryWithWriter 方法负责提供，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">CustomRecoveryWithWriter</span><span class="p">(</span><span class="nx">out</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">handle</span> <span class="nx">RecoveryFunc</span><span class="p">)</span> <span class="nx">HandlerFunc</span> <span class="p">{</span>	<span class="kd">var</span> <span class="nx">logger</span> <span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>	<span class="k">if</span> <span class="nx">out</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>		<span class="nx">logger</span> <span class="p">=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="s">&#34;\n\n\x1b[31m&#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nx">LstdFlags</span><span class="p">)</span>	<span class="p">}</span>	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>		<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>				<span class="c1">// Check for a broken connection, as it is not really a				// condition that warrants a panic stack trace.				var brokenPipe bool				if ne, ok := err.(*net.OpError); ok {					if se, ok := ne.Err.(*os.SyscallError); ok {						if strings.Contains(strings.ToLower(se.Error()), &#34;broken pipe&#34;) || strings.Contains(strings.ToLower(se.Error()), &#34;connection reset by peer&#34;) {							brokenPipe = true						}					}				}				if logger != nil {					stack := stack(3)					httpRequest, _ := httputil.DumpRequest(c.Request, false)					headers := strings.Split(string(httpRequest), &#34;\r\n&#34;)					for idx, header := range headers {						current := strings.Split(header, &#34;:&#34;)						if current[0] == &#34;Authorization&#34; {							headers[idx] = current[0] + &#34;: *&#34;						}					}					headersToStr := strings.Join(headers, &#34;\r\n&#34;)					if brokenPipe {						logger.Printf(&#34;%s\n%s%s&#34;, err, headersToStr, reset)					} else if IsDebugging() {						logger.Printf(&#34;[Recovery] %s panic recovered:\n%s\n%s\n%s%s&#34;,							timeFormat(time.Now()), headersToStr, err, stack, reset)					} else {						logger.Printf(&#34;[Recovery] %s panic recovered:\n%s\n%s%s&#34;,							timeFormat(time.Now()), err, stack, reset)					}				}				if brokenPipe {					// If the connection is dead, we can&#39;t write a status to it.					c.Error(err.(error)) // nolint: errcheck					c.Abort()				} else {					handle(c, err)				}			}		}()		c.Next()	}}
</span></code></pre></td></tr></table>
</div>
</div><p>HandlerFunc 函数的运行逻辑分为两步：</p>
<ol>
<li>调用 defer 注册一个异常处理逻辑，将在 Context.Next() 返回后执行。</li>
<li>调用 Context.Next() 方法进行拦截过滤器模式的请求处理。</li>
</ol>
<p>可见，Gin 框架利用上述逻辑来处理一切从 Context.Next() 方法中抛出的 panic 异常。</p>
<p><strong>（3）链式调用模型与方法栈</strong></p>
<p>在 Gin 中，默认的 Logger 以及 Recovery 中间件由于主动执行了 Context.Next() 函数，因此在方法栈上看，这两个 HandlerFunc 类型的方法会先后压入方法栈。这两个方法与 Context.handlers 切片中其余 HandlerFunc 类型的方法实际上是链式调用的关系。</p>
<p>Context.handlers 切片中的 HandlerFunc 类型的方法如果内部不主动调用 Context.Next() 函数，那么切片内部元素之间并没有形成链式调用关系，这避免了方法栈过深。如下图所示：</p>
<p><img src="../../../images/img_gin/stack.gif" alt="stack"></p>
<p><strong>拦截过滤器的两种遍历方式：链式调用以及基于数组的遍历，它们的优缺点如下</strong>：</p>
<ul>
<li><strong>链式调用</strong>：
<ul>
<li><strong>优势</strong>：可以拿到后序处理器的处理情况，Logger 与 Recover 组件都需要后序处理的结果，因此选择链式调用。</li>
<li><strong>缺点</strong>：会增加方法栈深度，增加内存消耗（不考虑方法栈重用优化）。</li>
</ul>
</li>
<li><strong>数组遍历</strong>：
<ul>
<li><strong>优势</strong>：不会增加方法栈深度，goroutine 是轻量级协程，方法栈深度的下降有利于整个应用占用内存的下降</li>
<li><strong>缺点</strong>：无法得到后续处理器的执行情况，无法实现日志、panic 捕获等机制。</li>
</ul>
</li>
</ul>
<p>因此，Gin 的中间件如果要得到后续 HandlerFunc 方法的执行情况，可以选择显式调用 Context.Next()，否则不需要调用，Gin 会自动完成过滤器链的遍历。</p>
<h2 id="4-gin-的-goroutine-模型">4. Gin 的 Goroutine 模型</h2>
<p>学习 Go 语言最令人痴迷的是其 Goroutine 的使用。出于如下两个目标，现代后台系统通常会选择 NIO 而不是 BIO 作为网络通信框架：</p>
<ul>
<li>避免大量创建线程，线程切换的代价很大</li>
<li>能够处理海量的网络请求，避免浪费 CPU 资源</li>
</ul>
<p>基于 NIO 衍生出了基于事件的 Reactor 网络通信模型，Netty 是一个典型代表。这种通信模型的优势是整个后台框架的运行效率非常高，但缺陷是对程序员要求高，编程难度大。Goroutine 的 runtime 巧妙地解决了这个问题，使我们可以像传统 BIO 那样直接写可以阻塞于网络读写的 I/O 逻辑，只不过传统 BIO 中阻塞的是线程，而 Go 阻塞的是 Goroutine。</p>
<p>Go 的 HTTP 后台框架模型可以表示为如下伪码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//while 循环
</span><span class="c1"></span><span class="k">for</span><span class="p">{</span>
  <span class="c1">//1.阻塞监听某一个端口，当有新连接到来时，停止阻塞
</span><span class="c1"></span>  <span class="nx">conn</span> <span class="o">:=</span> <span class="nf">accept</span><span class="p">()</span>
  <span class="c1">//2.新建一个协程，负责该新连接的处理
</span><span class="c1"></span>  <span class="k">go</span> <span class="nf">ioProcess</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>下面我们看看 Gin 是如何做到的。</p>
<p>首先我们来看 Gin.Run 方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">addr</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nf">debugPrintError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">}()</span>

	<span class="nx">trustedCIDRs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nf">prepareTrustedCIDRs</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">engine</span><span class="p">.</span><span class="nx">trustedCIDRs</span> <span class="p">=</span> <span class="nx">trustedCIDRs</span>
	<span class="nx">address</span> <span class="o">:=</span> <span class="nf">resolveAddress</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
	<span class="nf">debugPrint</span><span class="p">(</span><span class="s">&#34;Listening and serving HTTP on %s\n&#34;</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">engine</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中最关键的步骤是将 Gin 中的 Engine 结构体实例作为 Go 官方 http 包的 ListenAndServe 方法的入口参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">Handler</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>	<span class="nx">server</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Addr</span><span class="p">:</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">Handler</span><span class="p">:</span> <span class="nx">handler</span><span class="p">}</span>	<span class="k">return</span> <span class="nx">server</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">()}</span>
</code></pre></td></tr></table>
</div>
</div><p>Engine 结构体实际上实现了 http.Handler 接口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Handler</span> <span class="kd">interface</span> <span class="p">{</span>	<span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)}</span>
</code></pre></td></tr></table>
</div>
</div><p>其实现方式如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//从缓存得到一个 Context 实例	c := engine.pool.Get().(*Context)  //进行相关结构体的重置，并与当前请求建立关系	c.writermem.reset(w)	c.Request = req	c.reset()	//这个方法负责处理请求	engine.handleHTTPRequest(c)	//归还缓存，由于 Recovery 中间件会负责处理 panic，因此这里总是可以执行到	engine.pool.Put(c)}
</span></code></pre></td></tr></table>
</div>
</div><p>我们在本文第二章中已经提到了 Engine.handleHTTPRequest 是基于拦截过滤器调用逻辑实现的，这里就不在复述了。</p>
<p><strong>Spring 一个常见的问题是：Spring 与 Tomcat 的关系是什么？</strong></p>
<p>一个简单的回答是 Spring 的 DispatcherServlet 作为全局路由器被嵌入到 Tomcat 中，DispatcherServlet 的静态逻辑会负责加载 Spring 容器，最终提供 Spring Web 的各种功能。</p>
<p><strong>那么 Gin 框架与 Go 官方提供的 http 包有什么关系？</strong></p>
<p>首先，http 包中 Server 结构体的 ListenAndServe 会负责监听指定端口，当有新连接接入时，就会启动一个 goroutine 来处理此新连接。代码如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">fn</span> <span class="o">:=</span> <span class="nx">testHookServerServe</span><span class="p">;</span> <span class="nx">fn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">fn</span><span class="p">(</span><span class="nx">srv</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span> <span class="c1">// call hook with unwrapped listener
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="nx">origListener</span> <span class="o">:=</span> <span class="nx">l</span>
	<span class="nx">l</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">onceCloseListener</span><span class="p">{</span><span class="nx">Listener</span><span class="p">:</span> <span class="nx">l</span><span class="p">}</span>
	<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">setupHTTP2_Serve</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">srv</span><span class="p">.</span><span class="nf">trackListener</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">l</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">ErrServerClosed</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">trackListener</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">l</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>

	<span class="nx">baseCtx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">BaseContext</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">baseCtx</span> <span class="p">=</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">BaseContext</span><span class="p">(</span><span class="nx">origListener</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">baseCtx</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;BaseContext returned a nil context&#34;</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">tempDelay</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="c1">// how long to sleep on accept failure
</span><span class="c1"></span>
	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">baseCtx</span><span class="p">,</span> <span class="nx">ServerContextKey</span><span class="p">,</span> <span class="nx">srv</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">rw</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">srv</span><span class="p">.</span><span class="nf">getDoneChan</span><span class="p">():</span>
				<span class="k">return</span> <span class="nx">ErrServerClosed</span>
			<span class="k">default</span><span class="p">:</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">ne</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Error</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">ne</span><span class="p">.</span><span class="nf">Temporary</span><span class="p">()</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">tempDelay</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
					<span class="nx">tempDelay</span> <span class="p">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nx">tempDelay</span> <span class="o">*=</span> <span class="mi">2</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="nx">max</span> <span class="o">:=</span> <span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">;</span> <span class="nx">tempDelay</span> <span class="p">&gt;</span> <span class="nx">max</span> <span class="p">{</span>
					<span class="nx">tempDelay</span> <span class="p">=</span> <span class="nx">max</span>
				<span class="p">}</span>
				<span class="nx">srv</span><span class="p">.</span><span class="nf">logf</span><span class="p">(</span><span class="s">&#34;http: Accept error: %v; retrying in %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">tempDelay</span><span class="p">)</span>
				<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">tempDelay</span><span class="p">)</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="nx">connCtx</span> <span class="o">:=</span> <span class="nx">ctx</span>
		<span class="k">if</span> <span class="nx">cc</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">ConnContext</span><span class="p">;</span> <span class="nx">cc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">connCtx</span> <span class="p">=</span> <span class="nf">cc</span><span class="p">(</span><span class="nx">connCtx</span><span class="p">,</span> <span class="nx">rw</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">connCtx</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;ConnContext returned nil&#34;</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nx">tempDelay</span> <span class="p">=</span> <span class="mi">0</span>
		<span class="nx">c</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">newConn</span><span class="p">(</span><span class="nx">rw</span><span class="p">)</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">,</span> <span class="nx">StateNew</span><span class="p">,</span> <span class="nx">runHooks</span><span class="p">)</span> <span class="c1">// before Serve can return
</span><span class="c1"></span>    <span class="c1">//启动一个 Goroutine 来处理新连接
</span><span class="c1"></span>		<span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">serve</span><span class="p">(</span><span class="nx">connCtx</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>conn 结构体实例代表一个新连接，其 serve 方法比较长，因为处理 HTTP 请求本身就涉及很多复杂的处理逻辑（例如 HTTP 版本就很多，还包括 HTTPS 的握手建立）。</p>
<p>不过最关键的是 conn.serve 方法会调用 http.Handler.ServeHTTP 方法，最终就会调用 Gin 框架中 Engine 对此接口的具体实现。源码比较长，不贴了，这里给出链接：https://github.com/golang/go/blob/release-branch.go1.16/src/net/http/server.go#L1952</p>
<h2 id="5-summary">5. SUMMARY</h2>
<ul>
<li>Gin 与基于 Netty 的 HTTP 后台启动逻辑类似，可以归纳为三步：初始化后台服务引擎、配置路由规则、监听后台端口</li>
<li>Gin 依赖于拦截过滤器模式来处理请求，过滤器在 Gin 中被称为中间件，其本质上是实现了 HandlerFunc 接口的任意函数。通过 Context.Next() 方法来实现请求在过滤器上的遍历处理，通过调用 Context.Abort() 方法能够提前结束遍历逻辑</li>
<li>Gin 拦截过滤器链中的默认的中间件是 Logger 以及 Recovery，它们分别用于实现日志以及 panic 捕获处理。我们还分析了拦截过滤器链两种执行方式的优缺点。</li>
<li>Gin 通过 Engine 实现 http.Handler 接口的 ServeHTTP 方法，注入到 http 包中。http 包会负责在新连接到来时，启动一个新的 goroutine。此 goroutine 会负责调用 Engine.ServeHTTP 方法，实现 HTTP 请求的逻辑处理。</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/gin/">Gin</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/go/redislock/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go 语言下基于 Redis 的分布式锁</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/mysql/joininmysql/">
            <span class="next-text nav-default">MySQL join 学习</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>


      <h3>转载申请</h3>
      <a rel=license href=https://creativecommons.org/licenses/by/4.0>
        <img alt=知识共享许可协议 style=border-width:0 src=../../static/creative-commons.png>
      </a>
      <br>本作品采用
      <a rel=license href=http://creativecommons.org/licenses/by/4.0/ target="_blank" style="text-decoration:underline;" >
      知识共享署名 4.0 国际许可协议</a>
      进行许可，转载时请注明作者姓名以及原文链接，图片在使用时请保留全部内容，可适当缩放并在引用处附上图片所在的文章链接。

      
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2021-05-19 16:50:11 \u002b0800 CST',
        title: '写给 Java 程序员的 Go Web 框架 Gin 源码入门',
        clientID: 'b8e9909664fb69930809',
        clientSecret: '847d9069c9532ab260721afb9f036cdb8f52aec4',
        repo: 'Spongecaptain.github.io',
        owner: 'Spongecaptain',
        admin: ['Spongecaptain'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:wjjiang19@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/spongecaptain" class="iconfont icon-github" title="github"></a>
  <a href="https://spongecaptain.cool/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2022
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Spongecaptain</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.2517c0eb67172a0bae917de4af59b10ca2531411a009d4c0b82f5685259e5771.js"></script>








</body>
</html>
